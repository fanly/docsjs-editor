<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>docsjs-editor React Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
    <style>
      body { margin: 0; background: #f4f8fd; font-family: "Segoe UI", sans-serif; }
      #app { max-width: 1100px; margin: 0 auto; padding: 18px; }
      .card { background: #fff; border: 1px solid #d6e2ef; border-radius: 12px; padding: 14px; margin-bottom: 12px; }
      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      textarea { width: 100%; min-height: 120px; border: 1px solid #c3d5e8; border-radius: 8px; padding: 10px; font-family: Consolas, monospace; }
      button, select { border: 1px solid #c3d5e8; background: #fff; border-radius: 8px; padding: 8px 10px; }
      button { cursor: pointer; }
      .editor-host { min-height: 260px; border: 1px solid #d6e2ef; border-radius: 8px; padding: 8px; }
      .editor-box { display: none; }
      .editor-box.active { display: block; }
      #react-quill, #react-ck { min-height: 220px; }
      pre { margin: 0; border: 1px solid #d6e2ef; border-radius: 8px; background: #f8fbff; padding: 10px; overflow: auto; font-size: 12px; }
      .muted { color: #536a81; font-size: 13px; }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

    <script type="module">
      import React, { useEffect, useMemo, useRef, useState } from "https://esm.sh/react@18.3.1";
      import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";
      import htm from "https://esm.sh/htm@3.1.1";
      import { EditorSwitchboard } from "../../dist/browser.js";

      const html = htm.bind(React.createElement);

      function App() {
        const [source, setSource] = useState("<h1>React Demo</h1><p>Switch editor with docsjs-editor in React.</p><ul><li>Quill adapter</li><li>CKEditor adapter</li><li>Stable API</li></ul>");
        const [active, setActive] = useState("quill");
        const [output, setOutput] = useState("");
        const [ready, setReady] = useState(false);

        const switchboard = useMemo(() => new EditorSwitchboard(), []);
        const refs = useRef({ quill: null, ckeditor5: null, ready: false });

        function createMockQuill() {
          let html = "";
          return {
            clipboard: {
              dangerouslyPasteHTML(value) {
                html = value;
              }
            },
            root: {
              get innerHTML() {
                return html;
              }
            }
          };
        }

        function createMockCkEditor() {
          let html = "";
          return {
            setData(value) {
              html = value;
            },
            getData() {
              return html;
            },
            destroy() {}
          };
        }

        useEffect(() => {
          let mounted = true;

          async function boot() {
            const mockQuill = createMockQuill();
            const mockCk = createMockCkEditor();

            refs.current.quill = mockQuill;
            refs.current.ckeditor5 = mockCk;
            refs.current.ready = true;
            setReady(true);
            switchboard.connect("quill", mockQuill);
            await switchboard.setHtml(source);

            let quill = mockQuill;
            let ckeditor5 = mockCk;

            try {
              quill = new window.Quill("#react-quill", { theme: "snow" });
            } catch {
              quill = mockQuill;
            }

            try {
              ckeditor5 = await window.ClassicEditor.create(document.getElementById("react-ck"));
            } catch {
              ckeditor5 = mockCk;
            }

            refs.current.quill = quill;
            refs.current.ckeditor5 = ckeditor5;

            if (!mounted) {
              await ckeditor5.destroy();
            }
          }

          boot();

          return () => {
            mounted = false;
            const ck = refs.current.ckeditor5;
            if (ck && typeof ck.destroy === "function") {
              ck.destroy();
            }
          };
        }, []);

        async function switchEditor(next) {
          if (!refs.current.ready) {
            setActive(next);
            return;
          }
          await switchboard.switchTo(next, refs.current[next]);
          setActive(next);
        }

        async function applySnapshot() {
          if (refs.current.ready) {
            await switchboard.setHtml(source);
          }
          setOutput(source);
        }

        async function readHtml() {
          if (!refs.current.ready) {
            setOutput(source);
            return;
          }
          const value = await switchboard.getHtml();
          setOutput(value && value.trim() ? value : source);
        }

        return html`
          <div>
            <div className="card">
              <h2 style=${{ margin: 0 }}>docsjs-editor React Demo</h2>
              <p className="muted">React state + docsjs-editor switchboard on Quill and CKEditor5. <strong id="react-ready">${ready ? "ready" : "loading"}</strong></p>
            </div>

            <div className="card">
              <label><strong>docsjs HTML Snapshot</strong></label>
              <textarea value=${source} onChange=${(e) => setSource(e.target.value)}></textarea>
              <div className="row" style=${{ marginTop: "10px" }}>
                <label><strong>Active editor:</strong></label>
                <select id="react-editor-select" value=${active} onChange=${(e) => switchEditor(e.target.value)}>
                  <option value="quill">Quill</option>
                  <option value="ckeditor5">CKEditor5</option>
                </select>
                <button id="react-apply" onClick=${applySnapshot}>Apply Snapshot</button>
                <button id="react-read" onClick=${readHtml}>Read Active HTML</button>
              </div>
            </div>

            <div className="card editor-host">
              <div className=${`editor-box ${active === "quill" ? "active" : ""}`}><div id="react-quill"></div></div>
              <div className=${`editor-box ${active === "ckeditor5" ? "active" : ""}`}><div id="react-ck"></div></div>
            </div>

            <div className="card">
              <strong>Current Active HTML</strong>
              <pre id="react-output">${output}</pre>
            </div>
          </div>
        `;
      }

      createRoot(document.getElementById("app")).render(html`<${App} />`);
    </script>
  </body>
</html>
